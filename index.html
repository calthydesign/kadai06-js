<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç”»åƒèªè¨¼ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <link rel="stylesheet" href="reset.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-storage.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
  </head>
  <body>
    <header><h1>ç”»åƒèªè¨¼ã¤ããƒãƒ£ãƒƒãƒˆ</h1></header>
    <main>
      <div id="message">
        <div>
          <input type="file" id="file" />
        </div>
      </div>
      <div>åå‰ï¼š<input type="text" id="uname" /></div>
      <div>
        <div>
          <textarea id="text" cols="30" rows="5"></textarea>
        </div>
        <button id="send" type="button">
          <span id="up">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»é€ä¿¡</span>
        </button>
      </div>
      <div class="image_tensorflow">
        <p>ã“ã“ã«ç”»åƒèªè­˜ã®çµæœãŒå‡ºã¾ã™</p>
        <img id="preview" />
        <div id="results"></div>
      </div>
      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
      <div id="output"></div>
    </main>
    <!--/ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->

    <!-- ä»¥ä¸‹Firebase -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        update,
        remove,
        onChildAdded,
        onChildChanged,
        onChildRemoved,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      let firebaseConfig = {
        //firebaseã«æ¥ç¶šã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ•°
        apiKey: "AIzaSyDeFdVDmRQnigJlwdI1FFVPnx7HV2AsTOM",
        authDomain: "sample-c4768.firebaseapp.com",
        databaseURL: "https://sample-c4768-default-rtdb.firebaseio.com",
        projectId: "sample-c4768",
        storageBucket: "sample-c4768.appspot.com",
        messagingSenderId: "131805254183",
        appId: "1:131805254183:web:85024f84025f27a18a3402",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const app = initializeApp(firebaseConfig); //ã“ã®ã‚­ãƒ¼ã‚’æŒã£ã¦initializeAppã‚’å®Ÿè¡Œã™ã‚‹
      const db = getDatabase(app); //RealtimeDatabaseã«æ¥ç¶š  getDatabaseã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å–å¾—
      const dbRef = ref(db, "chat"); //ã©ã“ã®éšå±¤ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‹ã¨ã„ã†ã“ã¨  RealtimeDBã®"chat"ã‚’ã¤ã‹ã†

      //ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      document.getElementById("up").addEventListener("click", function () {
        let files = document.getElementById("file").files;
        let image = files[0];

        let ref = firebase.storage().ref().child(image.name);
        ref
          .put(image)
          .then(function (snapshot) {
            alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ");
            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—
            return snapshot.ref.getDownloadURL();
          })
          .then(function (url) {
            // ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹è¦ç´ ã‚’ä½œæˆ
            let img = document.createElement("img");
            img.src = url;
            // document.body.appendChild(img);
          })
          .catch(function (error) {
            console.error("ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
          });
      });

      //æŠ•ç¨¿æ™‚é–“ã®å–å¾—
      let now = new Date();
      const nowMon = now.getMonth() + 1;
      const nowDate = now.getDate();
      const nowHour = now.getHours();
      const nowMinute = now.getMinutes();
      const date = `${nowMon}/${nowDate} ${nowHour}:${nowMinute}`;

      // é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
      $("#send").on("click", function () {
        const uname = $("#uname").val();
        const text = $("#text").val();
        const file = $("#file")[0].files[0];

        let msg = {
          uname: uname,
          text: text,
        };

        if (file) {
          // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€URL ã‚’å–å¾—ã™ã‚‹
          let ref = firebase.storage().ref().child(file.name);
          ref
            .put(file)
            .then(function (snapshot) {
              return snapshot.ref.getDownloadURL();
            })
            .then(function (url) {
              // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç”»åƒã® URL ã‚’è¿½åŠ 
              msg.imageUrl = url;
              push(dbRef, msg);
              $("#text").val(""); // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ç©ºã«ã™ã‚‹
              $("#file").val(""); // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
            })
            .catch(function (error) {
              console.error("ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
            });
        } else {
          // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ã€ãã®ã¾ã¾ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
          push(dbRef, msg);
          $("#text").val(""); // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ç©ºã«ã™ã‚‹
        }
      });

      // onChildAdded ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
      onChildAdded(dbRef, function (data) {
        const msg = data.val();
        const key = data.key;
        let h = '<p id="' + key + '">';
        if (msg.imageUrl) {
          // ç”»åƒã® URL ãŒã‚ã‚‹å ´åˆã¯ img è¦ç´ ã‚’ä½œæˆ
          h += '<img width="300" src="' + msg.imageUrl + '" /><br>';
        }
        h += msg.uname + "<br>";
        h +=
          '<span contenteditable="true" id="' +
          key +
          '_update">' +
          msg.text +
          "</span>" +
          "<br>";
        h += date;
        h += '<span class="remove" data-key="' + key + '"> ğŸ—‘ï¸ </span>';
        h += '<span class="update" data-key="' + key + '"> â¤´ï¸ </span>';
        h += "</p>";
        $("#output").prepend(h);

        // ç”»åƒèªè­˜ã®çµæœã‚’è¡¨ç¤º
        if (msg.imageUrl) {
          const img = document.createElement("img");
          img.src = msg.imageUrl;

          img.onload = async () => {
            const predictions = await model.classify(img);
            const resultsDiv = document.getElementById("results-" + key);
            resultsDiv.innerHTML = "";
            predictions.forEach((prediction) => {
              const element = document.createElement("div");
              element.innerHTML = `${prediction.className}: ${(
                prediction.probability * 100
              ).toFixed(2)}%`;
              resultsDiv.appendChild(element);
            });
          };
        }
      });

      //æ›´æ–°
      onChildChanged(dbRef, function (data) {
        $("#" + data.key + "_update").text(data.val().text);
        $("#" + data.key + "_update")
          .fadeOut(100)
          .fadeIn(100)
          .fadeOut(100)
          .fadeIn(100);
      });

      onChildRemoved(dbRef, function (data) {
        $("#" + data.key).remove();
      });

      // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
      $("#output").on("click", ".remove", function () {
        const key = $(this).data("key");
        const chatRef = ref(db, "chat/" + key);
        remove(chatRef)
          .then(() => {
            $("#" + key).remove(); // è¦ç´ ã®å‰Šé™¤ã¯å‰Šé™¤å‡¦ç†ã®å®Œäº†å¾Œã«è¡Œã†
          })
          .catch((error) => {
            console.error("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
          });
      });

      // æ›´æ–°ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†(ä¿®æ­£ï¼‰
      $("#output").on("click", ".update", function () {
        const key = $(this).data("key");
        const text = $("#" + key + "_update").html();
        const uname = $("#" + key)
          .find("span:first")
          .text()
          .trim(); // .trim()ã‚’è¿½åŠ 
        const updatedMsg = { uname, text };
        update(ref(db, "chat/" + key), { uname, text });
      });

      // ãƒ¢ãƒ‡ãƒ«ã‚’éåŒæœŸã§ãƒ­ãƒ¼ãƒ‰
      async function loadModel() {
        const model = await mobilenet.load();

        const fileInput = document.getElementById("file");
        const preview = document.getElementById("preview");
        const results = document.getElementById("results");

        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›æ™‚ã®å‡¦ç†
        fileInput.addEventListener("change", async () => {
          const file = fileInput.files[0];
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);

          // ç”»åƒãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã«èªè­˜å‡¦ç†ã‚’å®Ÿè¡Œ
          img.onload = async () => {
            // ç”»åƒèªè­˜ã‚’å®Ÿè¡Œ
            const predictions = await model.classify(img);

            // çµæœã‚’è¡¨ç¤º
            results.innerHTML = "";
            predictions.forEach((prediction) => {
              const element = document.createElement("div");
              element.innerHTML = `${prediction.className}: ${(
                prediction.probability * 100
              ).toFixed(2)}%`;
              results.appendChild(element);
            });
          };

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ç”»åƒã‚’è¡¨ç¤º
          preview.src = img.src;
        });
      }

      loadModel();
    </script>
  </body>
</html>
